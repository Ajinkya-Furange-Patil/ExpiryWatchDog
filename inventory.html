<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Saved Products â€“ Expiry Watchdog</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="css/view-products.css" />
  </head>
  <body>
    <header class="navbar">
      <div class="nav-container">
        <div class="nav-logo">ðŸ“¦ Expiry Watchdog</div>

        <div class="nav-center">
          <label for="sort-filter">Sort by Expiry:</label>
          <select id="sort-filter" onchange="loadProducts()">
            <option value="">All Products</option>
            <option value="1month">Expiry in 1 Month</option>
            <option value="7days">Expiry in 7 Days</option>
            <option value="1day">Expiry in 1 Day</option>
            <option value="7days-expired">Expired within 7 Days</option>
            <option value="1month-expired">Expired within 1 Month</option>
            <option value="1year-expired">Expired within 1 Year</option>
            <option value="more-than-1year-expired">
              Expired Over 1 Year Ago
            </option>
          </select>
        </div>

        <div class="nav-action">
          <button class="btn" onclick="window.location.href='products.html'">
            âž• Add Product
          </button>
        </div>
      </div>
    </header>

    <main class="products-list">
      <table id="products-table">
        <thead>
          <tr>
            <th>Product Image</th>
            <th>Product Name</th>
            <th>Price</th>
            <th>Expiry Date</th>
            <th>Remaining Days</th>
          </tr>
        </thead>
        <tbody id="products-list"></tbody>
      </table>
      <p class="empty" id="empty-msg" style="display: none">
        No products saved yet.
      </p>
    </main>

    <
    <script>
      function daysRemaining(expiryDate) {
        const today = new Date();
        const expiry = new Date(expiryDate);
        const diff = expiry - today;
        return Math.ceil(diff / (1000 * 60 * 60 * 24));
      }

      function formatDaysRemaining(days) {
        const absDays = Math.abs(days);

        const years = Math.floor(absDays / 365);
        const months = Math.floor((absDays % 365) / 30);
        const weeks = Math.floor((absDays % 30) / 7);
        const remainingDays = absDays % 7;

        function pluralize(value, unit) {
          return value > 0 ? `${value} ${unit}${value === 1 ? "" : "s"}` : "";
        }

        let parts = [];
        if (years > 0) parts.push(pluralize(years, "year"));
        if (months > 0) parts.push(pluralize(months, "month"));
        if (weeks > 0) parts.push(pluralize(weeks, "week"));
        if (remainingDays > 0) parts.push(pluralize(remainingDays, "day"));

        if (days === 0) return "Today";
        if (days === 1) return "Tomorrow";
        if (days === -1) return "Yesterday";

        const formatted = parts.slice(0, 2).join(" and "); // Limit to 2 parts for clarity

        return days > 0 ? `${formatted} left` : `${formatted} ago`;
      }

      function formatDate(dateString) {
        const date = new Date(dateString);
        const day = String(date.getDate()).padStart(2, "0");
        const month = String(date.getMonth() + 1).padStart(2, "0"); // Months are 0-based
        const year = date.getFullYear();
        return `${day}/${month}/${year}`;
      }

      function loadProducts() {
        const tbody = document.getElementById("products-list");
        const emptyMsg = document.getElementById("empty-msg");
        const filter = document.getElementById("sort-filter")?.value || "";
        tbody.innerHTML = "";

        const products = JSON.parse(localStorage.getItem("products")) || [];

        if (products.length === 0) {
          emptyMsg.style.display = "block";
          return;
        }

        const filtered = products.filter((prod) => {
          const days = daysRemaining(prod.expiry);

          switch (filter) {
            case "1month":
              return days > 0 && days <= 30;
            case "7days":
              return days > 0 && days <= 7;
            case "1day":
              return days === 1;
            case "7days-expired":
              return days < 0 && days >= -7;
            case "1month-expired":
              return days < 0 && days >= -30;
            case "1year-expired":
              return days < 0 && days >= -365;
            case "more-than-1year-expired":
              return days < -365;
            default:
              return true;
          }
        });

        emptyMsg.style.display = filtered.length === 0 ? "block" : "none";

        filtered.forEach((prod) => {
          const days = daysRemaining(prod.expiry);
          const daysText = formatDaysRemaining(days);
          const tr = document.createElement("tr");
          tr.classList.add("fade-in");

          // Choose CSS class based on days remaining
          let statusClass = "";
          if (days > 30) {
            statusClass = "ok";
          } else if (days > 7) {
            statusClass = "safe";
          } else if (days > 1) {
            statusClass = "warning";
          } else if (days === 1) {
            statusClass = "danger";
          } else if (days >= -7) {
            statusClass = "expired-warning";
          } else if (days >= -30) {
            statusClass = "expired-danger";
          } else {
            statusClass = "dead";
          }

          const imgSrc =
            prod.image &&
            (prod.image.startsWith("http") || prod.image.startsWith("data:"))
              ? prod.image
              : "https://upload.wikimedia.org/wikipedia/commons/1/14/Product_sample_icon_picture.png";

          tr.innerHTML = `
      <td><img src="${imgSrc}" alt="${prod.name}" /></td>
      <td>${prod.name}</td>
      <td>â‚¹${prod.price || "N/A"}</td>
      <td>${formatDate(prod.expiry)}</td>
      <td class="${statusClass}">${daysText}</td>
    `;
          tbody.appendChild(tr);
        });
      }
      window.onload = loadProducts;
    </script>
  </body>
</html>
